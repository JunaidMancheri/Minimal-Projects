<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Ashion Template">
    <meta name="keywords" content="Ashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/static/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="/static/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <title>Order History</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap');

        /* Resetting */
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }



        #sidebar {
            padding: 15px 0px 15px 0px;
            border-radius: 10px;
        }

        #sidebar .h4 {
            font-weight: 500;
            padding-left: 15px;
        }

        #sidebar ul {
            list-style: none;
            margin: 0;
            padding-left: 0rem;
        }

        #sidebar ul li {
            padding: 10px 0;
            display: block;
            padding-left: 1rem;
            padding-right: 1rem;
            border-left: 5px solid transparent;
        }

        #sidebar ul li.active {
            border-left: 5px solid #ff5252;
            background-color: #44007c;
        }

        #sidebar ul li a {
            display: block;
        }

        #sidebar ul li a .fas,
        #sidebar ul li a .far {
            color: #ddd;
        }

        #sidebar ul li a .link {
            color: #fff;
            font-weight: 500;
        }

        #sidebar ul li a .link-desc {
            font-size: 0.8rem;
            color: #ddd;
        }

        #main-content {
            padding: 30px;
            border-radius: 15px;
        }

        #main-content .h5,
        #main-content .text-uppercase {
            font-weight: 600;
            margin-bottom: 0;
        }

        #main-content .h5+div {
            font-size: 0.9rem;
        }

        #main-content .box {
            padding: 10px;
            border-radius: 6px;
            width: 170px;
            height: 90px;
        }

        #main-content .box img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        #main-content .box .tag {
            font-size: 0.9rem;
            color: #000;
            font-weight: 500;
        }

        #main-content .box .number {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .order {
            padding: 10px 30px;
            min-height: 150px;
        }

        .order .order-summary {
            height: 100%;
        }

        .order .blue-label {
            background-color: #aeaeeb;
            color: #0046dd;
            font-size: 0.9rem;
            padding: 0px 3px;
        }

        .order .green-label {
            background-color: #a8e9d0;
            color: #008357;
            font-size: 0.9rem;
            padding: 0px 3px;
        }

        .order .fs-8 {
            font-size: 0.85rem;
        }

        .order .rating img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .order .rating .fas,
        .order .rating .far {
            font-size: 0.9rem;
        }

        .order .rating .fas {
            color: #daa520;
        }

        .order .status {
            font-weight: 600;
        }

        .order .btn.btn-primary {
            background-color: #fff;
            color: #4e2296;
            border: 1px solid #4e2296;
        }

        .order .btn.btn-primary:hover {
            background-color: #4e2296;
            color: #fff;
        }

        .order .progressbar-track {
            margin-top: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .order .progressbar-track .progressbar {
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 0rem;
        }

        .order .progressbar-track .progressbar li {
            font-size: 1.5rem;
            border: 1px solid #333;
            padding: 5px 10px;
            border-radius: 50%;
            background-color: #dddddd;
            z-index: 100;
            position: relative;
        }

        .order .progressbar-track .progressbar li.green {
            border: 1px solid #007965;
            background-color: #d5e6e2;
        }

        .order .progressbar-track .progressbar li::after {
            position: absolute;
            font-size: 0.9rem;
            top: 50px;
            left: 0px;
        }

        #tracker {
            position: absolute;
            border-top: 1px solid #bbb;
            width: 100%;
            top: 25px;
        }

        #step-1::after {
            content: 'Placed';
        }

        #step-2::after {
            content: 'Accepted';
            left: -10px;
        }

        #step-3::after {
            content: 'Packed';
        }

        #step-4::after {
            content: 'Shipped';
        }

        #step-5::after {
            content: 'Delivered';
            left: -10px;
        }



        /* Backgrounds */
        .bg-purple {
            background-color: #55009b;
        }

        .bg-light {
            background-color: #f0ecec !important;
        }

        .green {
            color: #007965 !important;
        }

        /* Media Queries */


        @media(max-width: 500px) {
            .order .progressbar-track .progressbar li {
                font-size: 1rem;
            }

            .order .progressbar-track .progressbar li::after {
                font-size: 0.8rem;
                top: 35px;
            }

            #tracker {
                top: 20px;
            }
        }

        @media(max-width: 440px) {
            #main-content {
                padding: 20px;
            }

            .order {
                padding: 20px;
            }

            #step-4::after {
                left: -5px;
            }
        }

        @media(max-width: 395px) {
            .order .progressbar-track .progressbar li {
                font-size: 0.8rem;
            }

            .order .progressbar-track .progressbar li::after {
                font-size: 0.7rem;
                top: 35px;
            }

            #tracker {
                top: 15px;
            }

            .order .btn.btn-primary {
                font-size: 0.85rem;
            }
        }

        @media(max-width: 355px) {
            #main-content {
                padding: 15px;
            }

            .order {
                padding: 10px;
            }
        }

        .img img {
            width: 40px;
            height: 40px;
        }

        .img div {
            padding: 1rem;
        }

        .products {
            overflow-y: scroll;
            height: 50vh;
        }

        .red {
            color: red !important;
            border-color: red !important;

        }
    </style>
</head>







<body style="background-color:#eee ;">
    <%- include('./partials/user-navbar.ejs') %>



        <div class="container mt-4">
            <div class="row">

                <div class="col-lg-12 my-lg-0 my-1">
                    <div id="main-content" class="bg-white border">
                        <div class="d-flex flex-column">
                            <div class="h5">Hello <%= user.firstName %>
                            </div>

                        </div>
                        <div class="d-flex my-4 flex-wrap">
                            <div class="box me-4 my-1 bg-light">
                                <img src="https://www.freepnglogos.com/uploads/box-png/cardboard-box-brown-vector-graphic-pixabay-2.png"
                                    alt="">
                                <div class="d-flex align-items-center mt-2">
                                    <div class="tag">Orders placed</div>
                                    <div class="ms-auto number">
                                        <%= orders.length %>
                                    </div>
                                </div>
                            </div>
                            <div class="box me-4 my-1 bg-light">
                                <img src="https://www.freepnglogos.com/uploads/shopping-cart-png/shopping-cart-campus-recreation-university-nebraska-lincoln-30.png"
                                    alt="">
                                <div class="d-flex align-items-center mt-2">
                                    <div class="tag">Items in Cart</div>
                                    <div class="ms-auto number">
                                        <%= user.cartCount %>
                                    </div>
                                </div>
                            </div>
                            <div class="box me-4 my-1 bg-light">
                                <img src="https://www.freepnglogos.com/uploads/love-png/love-png-heart-symbol-wikipedia-11.png"
                                    alt="">
                                <div class="d-flex align-items-center mt-2">
                                    <div class="tag">Wishlist</div>
                                    <div class="ms-auto number">10</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-uppercase">My recent orders</div>
                        <% orders.forEach((order)=> { %>
                            <div class="order my-3 bg-light">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <div class="d-flex flex-column justify-content-between order-summary">
                                            <div class="d-flex align-items-center">
                                                <div class="text-uppercase">Order <%= order.orderId %>
                                                </div>

                                                <div class="blue-label ms-auto text-uppercase">
                                                    <%= order.paymentMethod %>
                                                </div>
                                            </div>
                                            <div class="img d-flex align-items-center">

                                                <img class=""
                                                    src="/static/uploads/<%= order.products[0].product.category %>/<%= order.products[0].product.designCode %>/<%= order.products[0].product.images[0] %>"
                                                    alt="">
                                                <div class="">
                                                    <%= order.products[0].product.name %>
                                                </div>



                                            </div>
                                            <div class="fs-8">Products #<%= order.products.length %>
                                            </div>
                                            <!--                                    
                                    <div class="rating d-flex align-items-center pt-1">
                                        <img src="https://www.freepnglogos.com/uploads/like-png/like-png-hand-thumb-sign-vector-graphic-pixabay-39.png"
                                            alt=""><span class="px-2">Rating:</span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>
                                    </div> -->
                                        </div>
                                    </div>
                                    <div class="col-lg-8">
                                        <div class="d-sm-flex align-items-sm-start justify-content-sm-between">
                                            <div class="status" id="<%= order._id %>Status">Status : <%= order.status %>
                                            </div>
                                            <% const date=new Date(order.createdAt) %>
                                                <div class="fs-8">
                                                    <%= date.toLocaleDateString('en-US', {day: 'numeric' , month: 'long'
                                                        , year: 'numeric' }); %> | <%= date.toLocaleTimeString('en-US',
                                                            { hour12: true, hour: 'numeric' , minute: 'numeric' }); %>
                                                </div>

                                                <button class="btn btn-primary text-uppercase"
                                                    data-target=".bd-example-modal-lg" data-toggle="modal"
                                                    onclick="orderDetails('<%= order._id %>')">order info</button>
                                        </div>
                                        <div class="progressbar-track">
                                            <ul class="progressbar">
                                                <!-- <li id="step-1" class="text-muted green">
                                            <span class="fa fa-gift"></span>
                                        </li> -->
                                                <li id="<%= order._id %>Accepted"
                                                    class="text-muted <% if (order.status == 'Confirmed' || order.status == 'Shipped' || order.status == 'Delivered') {%> green <% } %> <% if ( order.status != 'Confirmed' && order.status != 'Shipped' && order.status != 'Delivered') { %> red <% } %>">
                                                    <span class="fa fa-check"></span>
                                                </li>
                                                <!-- <li id="step-3" class="text-muted green">
                                            <span class="fa fa-gift"></span>
                                        </li> -->
                                                <li id="<%= order._id %>Shipped"
                                                    class="text-muted <% if (order.status == 'Delivered' || order.status == 'Shipped') {%> green <% } %> <% if ( order.status != 'Confirmed' && order.status != 'Shipped' && order.status != 'Delivered') { %> red <% } %>">
                                                    <span class="fa fa-truck"></span>
                                                </li>
                                                <li id="<%= order._id %>Delivered"
                                                    class="text-muted <% if (order.status == 'Delivered' ) {%> green <% } %> <% if ( order.status != 'Confirmed' && order.status != 'Shipped' && order.status != 'Delivered') { %> red <% } %>">
                                                    <span class="fa fa-truck"></span>
                                                </li>
                                            </ul>
                                            <div id="tracker"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% }) %>

                    </div>
                </div>
            </div>

        </div>
        <!--Order modal -->
        <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg colorbg" style="max-width: 1068px; background-color: #8282b229;">
                <div class="modal-content">
                    <section style="background-color: #8282b229;" class="mt-3" id="orderContainer">
                        <!-- Checkout Section Begin -->

                        <!-- Checkout Section End -->



                    </section>

                </div>
            </div>
        </div>




        <script src="/static/js/jquery-3.3.1.min.js"></script>
        <script src="/static/js/bootstrap.min.js"></script>
        <script src="/static/js/jquery.magnific-popup.min.js"></script>
        <script src="/static/js/jquery-ui.min.js"></script>
        <script src="/static/js/mixitup.min.js"></script>
        <script src="/static/js/jquery.countdown.min.js"></script>
        <script src="/static/js/jquery.slicknav.js"></script>
        <script src="/static/js/owl.carousel.min.js"></script>
        <script src="/static/js/jquery.nicescroll.min.js"></script>
        <script src="/static/js/main.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
            integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
            crossorigin="anonymous"></script>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
            integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD"
            crossorigin="anonymous"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</body>
<script>

            function isReturnExpired(createdAt) {
            const createdAtDate = new Date(createdAt);
            const returnEndDate = new Date(createdAtDate.getTime() + 14 * 24 * 60 * 60*  1000);
            const currentDate = new Date();
            return currentDate > returnEndDate;
            }
    const order = document.getElementById('orderContainer');
    function orderDetails(id) {
        fetch('/order/details', {
            method: 'POST',
            body: JSON.stringify({
                id: id,
            }),
            headers: {
                'Content-Type': 'application/json',
            },
        }).then((response) => response.json()).then((data) => {
            if (data.success) {
                const details = data.order;

                order.innerHTML = `
                <section class="checkout spad">
            <div class="container">
                <!-- billing address -->
                <form id="successForm" method='POST'  >
                    <div class="row colorbg ">

                        <div class="col-lg-8 col-md-8 billLabel ">
                            <div class="row">
                                <div class="col-lg-12 font-weight-500">
                                    <h5>Billed Address</h5>
                                </div>
                                <div class="col-lg-12 text-start mt-2">
                                    email: ${details.billingAddress.email} <br>
                                    phone: ${details.billingAddress.phone} <br>
                                    ${details.billingAddress.name}, <br>
                                    ${details.billingAddress.address}, <br>
                                    ${details.billingAddress.city}, ${details.billingAddress.state}, ${details.billingAddress.country} <br>
                                    PINCODE: ${details.billingAddress.zip}, <br>

                                </div>
                                <hr>
                                <div class="col-lg-12 my-3">
                                    <h6 class="my-2 ">Ordered Products</h6>
                                    <div class="row products borderbg" id='eachProduct'>
                                       
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4 ">
                            <div class="checkout__order" id='buttonContainer'>

                                <div class="checkout__order__total">
                                    <ul>
                                        <li>Order ID <input type="text" id="" name="coupon"
                                            class="total couponInput" value="${details.orderId}" readonly></li>
                                        <li>Coupon Applied <input type="text" id="couponCode" name="coupon"
                                                class="total couponInput" value="${details.coupon}" readonly></li>
                                        <li>Subtotal <input type="text" name="subTotal" id="subTotal"
                                                class="total checkoutInput" value="${details.subTotal}" readonly></li>
                                        <li>Discount <input type="text" id="discount" name="discount"
                                                class="total checkoutInput" value="${details.discount}" readonly></li>
                                        <li>Total <sup>(tax included*)</sup> <input name="total" type="text" id="total"
                                                class="total checkoutInput" readonly value="${details.totalAmount}"></li>
                                        <li>Payment Mode <input name="total" type="text" id="total"
                                                class="total checkoutInput" readonly value="${details.paymentMethod}"></li>
                                    </ul>
                                </div>
                                 
                               
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>`;
                let status;
                const btnContainer = document.getElementById('buttonContainer');
                if (details.status === 'Confirmed' || details.status === 'Shipped') {
                    btnContainer.innerHTML += '<button type="submit" id="cancelButton" class="site-btn">Cancel Order</button>'
                    status = 'Cancelled';

                } else if (details.status === 'Delivered') {
                    if (!isReturnExpired(details.createdAt)) {
                        btnContainer.innerHTML += '<button type="submit" id="returnButton" class="site-btn">Return</button>'
                    status = 'Return processing';
                    }
                   
                } else if (details.status === 'Return processing' || details.status === 'Return Confirmed') {
                    btnContainer.innerHTML += '<button type="submit" id="cancelReturnButton" class="site-btn">Cancel Return</button>'
                    status = 'Delivered';
                }
                const form = document.getElementById('successForm');
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    swal({
                        title: "Are you sure?",
                        text: "You want to continue the process?",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    })
                        .then((willDelete) => {
                            if (willDelete) {
                                fetch('/order/change/status', {
                        method: 'PATCH',
                        body: JSON.stringify({
                            id: details._id,
                            status: status,
                            products: details.products,
                        }),
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    }).then((response) => response.json()).then((data) => {
                        if (data.success) {
                            document.getElementById(`${details._id}Status`).innerHTML = `Status : ${status}`;
                            const accepted = document.getElementById(`${details._id}Accepted`)
                            const shipped = document.getElementById(`${details._id}Shipped`)
                            const delivered = document.getElementById(`${details._id}Delivered`)
                            if (status == 'Cancelled' || status == 'Return processing') {
                                accepted.classList.add('red');
                                shipped.classList.add('red');
                                delivered.classList.add('red');

                                accepted.classList.remove('green');
                                shipped.classList.remove('green');
                                delivered.classList.remove('green');
                            } else {
                                accepted.classList.add('green');
                                shipped.classList.add('green');
                                delivered.classList.add('green');

                                accepted.classList.remove('red');
                                shipped.classList.remove('red');
                                delivered.classList.remove('red');

                            }


                            if (status == 'Cancelled') {
                                const btn = document.getElementById('cancelButton')
                                btn.parentNode.removeChild(btn);
                            } else if (status == 'Return processing') {
                                const btn1 = document.getElementById('returnButton')
                                console.log(btn1, btn1.parentNode)
                                btn1.parentNode.removeChild(btn1);
                                console.log(btn1, btn1.parentNode)
                                btnContainer.innerHTML += '<button type="submit" id="cancelReturnButton" class="site-btn">Return</button>'
                                status = 'Delivered';
                            } else {
                                const btn2 = document.getElementById('cancelReturnButton')
                                btn2.parentNode.removeChild(btn2);
                                btnContainer.innerHTML += '<button type="submit" id="returnButton" class="site-btn">Cancel Return</button>'
                                status = 'Return processing';

                            }


                        }
                    })
                                
                            } 
                        });
                   

                });





                const eachProduct = document.getElementById('eachProduct');
                details.products.forEach((product) => {


                    eachProduct.innerHTML += ` <div class="items col-lg-12 my-3">
                                            <div class="row">
                                                <img class="col-lg-2" src="/static/uploads/${product.product.category}/${product.product.designCode}/${product.product.images[0]}"alt="">
                                                <div class=" col-lg-10">
                                                  <a href="/product/${product.product._id}"><span>${product.product.name} </span></a><br>
                                                  <small>Size: ${product.size}</small><br>
                                                  <small>Quantity: ${product.quantity}</small><br>
                                                  <small>Price: ${product.price}</small><br>
                                                </div>
                                            </div>
                                        </div>`
                })
            }
        })


    }


</script>

</html>